# 📘 Word 智能填写系统 - 完整使用指南

## 🎯 系统概述

这是一个集成大语言模型(LLM)的智能Word文档填写系统。它能够：

1. ✓ 分割Word文档为单独的页面
2. ✓ 使用大模型理解页面内容和字段
3. ✓ 根据提供的数据智能填写文档
4. ✓ 保留所有原始格式
5. ✓ 合并并导出为新的Word文档

---

## 🚀 快速开始（5分钟）

### 前提条件
- Python 3.7+
- Word文件 (template.docx)
- LLM API密钥 (OpenAI、Claude等)

### 第1步：配置LLM
```bash
python setup_llm_config.py
```

按照提示输入：
- 选择LLM服务商（OpenAI、Claude等）
- 输入API Key
- 输入API URL
- 输入Model名称

### 第2步：准备填充数据
编辑或创建 `fill_data.json`：

```json
{
  "page_1": {
    "project_name": "项目名称",
    "package_number": "包编号"
  },
  "page_2": {
    "company_name": "公司名称",
    "legal_representative": "法人代表"
  }
}
```

### 第3步：运行工作流
```bash
python smart_workflow.py
```

该脚本会自动执行：
1. 分割页面
2. 检查配置
3. 调用LLM处理
4. 合并页面
5. 生成Word文档

### 第4步：查看结果
打开生成的 `output_document.docx`

---

## 📋 详细步骤说明

### 步骤1：配置LLM（setup_llm_config.py）

#### 支持的LLM服务商

| 服务商 | 特点 | 推荐指数 |
|--------|------|--------|
| **OpenAI** | 功能强大、性价比高 | ⭐⭐⭐⭐⭐ |
| **Claude** | 文本理解能力强 | ⭐⭐⭐⭐⭐ |
| **通义千问** | 国内服务、支持中文 | ⭐⭐⭐⭐ |
| **智谱清言** | 国产大模型 | ⭐⭐⭐⭐ |
| **自定义API** | 灵活扩展 | ⭐⭐⭐ |

#### 获取API Key

**OpenAI:**
1. 访问 https://platform.openai.com/api-keys
2. 创建新的API Key
3. 复制Key值

**Claude (Anthropic):**
1. 访问 https://console.anthropic.com/
2. 创建API Key
3. 复制Key值

**通义千问 (阿里):**
1. 访问 https://dashscope.console.aliyun.com/
2. 创建API Key
3. 复制Key值

### 步骤2：准备填充数据（fill_data.json）

数据文件格式：
```json
{
  "page_1": {
    "field_name": "field_value",
    ...
  },
  "page_2": {
    ...
  },
  ...
}
```

**常见字段示例：**

```json
{
  "page_1": {
    "project_name": "中铝集团2026年采购项目",
    "project_code": "CPC-2026-001",
    "budget": "500万元",
    "start_date": "2026-03-01",
    "end_date": "2026-12-31"
  },
  "page_2": {
    "bidder_name": "某某公司有限责任公司",
    "registration_number": "统一社会信用代码",
    "legal_representative": "张三",
    "legal_representative_id": "身份证号",
    "contact_phone": "010-12345678",
    "contact_email": "contact@company.com"
  },
  "page_3": {
    "service_content": "提供项目管理咨询服务",
    "service_scope": "项目全周期管理",
    "service_term_months": "12",
    "key_personnel": ["张三（项目经理）", "李四（技术总监）"]
  }
}
```

### 步骤3：运行自动化工作流

```bash
python smart_workflow.py
```

工作流会自动执行以下步骤：

1. **前置检查** - 验证所需文件和配置
2. **页面分割** - 使用split_pages.py分割Word
3. **LLM处理** - 使用process_with_llm.py调用大模型
4. **页面合并** - 使用merge_pages.py合并修改
5. **转为Word** - 使用xml_to_docx.py生成最终文档

---

## 🔧 模块说明

### llm_connector.py
**LLM连接模块** - 统一管理与各种LLM的连接

主要类：
- `LLMConfig` - 配置数据类
- `LLMConnector` - 通用连接器（支持多个服务商）
- `LLMProvider` - 服务商枚举

使用示例：
```python
from llm_connector import LLMConnector, load_config_from_file

config = load_config_from_file('llm_config.json')
llm = LLMConnector(config)
response = llm.call("用户提示词", "系统提示词")
```

### prompt_library.py
**提示词模板库** - 预定义的高级提示词

提供的模板：
- `tender_form` - 招标文件表单填写
- `contract_clause` - 合同条款智能填写
- `table_data` - 表格数据智能填充
- `free_text` - 自由文本智能生成
- `xml_validation` - XML格式验证和修复
- `data_extraction` - 页面数据提取和理解

使用示例：
```python
from prompt_library import PromptLibrary

template = PromptLibrary.get_template('tender_form')
system, user = template.format(
    page_num=1,
    page_title="首页",
    fields_to_fill="...",
    provided_data="..."
)
```

### process_with_llm.py
**大模型处理脚本** - XML解析和LLM调用

主要类：
- `XMLPageAnalyzer` - 页面XML分析
- `LLMPageProcessor` - LLM处理器

主要函数：
- `process_all_pages_with_llm()` - 处理所有页面

### smart_workflow.py
**完整工作流脚本** - 一键自动化

运行命令：
```bash
python smart_workflow.py
```

---

## 📊 提示词优化指南

### 为什么提示词很重要

提示词的质量直接影响LLM的输出质量。好的提示词应该：
1. 清晰明确 - 准确描述任务
2. 包含上下文 - 提供足够的背景信息
3. 指定格式 - 明确期望的输出格式
4. 包含约束 - 说明限制条件
5. 给出示例 - 用示例说明期望

### 自定义提示词

编辑 `prompt_library.py` 中的模板：

```python
CUSTOM_TEMPLATE = PromptTemplate(
    name="自定义模板",
    system_prompt="""你是一个专业的...
    原则:
    1. ...
    2. ...
    """,
    user_prompt_template="""任务：...
    
    数据：{provided_data}
    
    要求：...
    
    输出格式：JSON"""
)
```

### 常见提示词技巧

**技巧1：指定输出格式**
```
请以JSON格式返回结果：
{
    "fields_filled": [...],
    "unfilled_fields": [...],
    "notes": "..."
}
```

**技巧2：包含约束条件**
```
重要约束：
- 金额必须与提供的数据完全一致
- 日期格式必须为 YYYY-MM-DD
- 人名不能被缩写或简化
```

**技巧3：使用角色设定**
```
你是一个资深的招标文件专家，具有20年的经验。
你需要确保所有填写的信息都符合国家招标法规。
```

**技巧4：分步说明**
```
请按照以下步骤处理：
1. 首先分析页面中的所有空白字段
2. 然后从提供的数据中匹配相应信息
3. 接下来验证数据的逻辑一致性
4. 最后输出修改列表
```

---

## 🛠️ 故障排除

### 问题1：API调用失败

**症状：** `API 调用失败` 或 `Connection error`

**解决方案：**
1. 检查网络连接
2. 检查API Key是否正确
3. 检查API URL是否正确
4. 检查API额度是否充足
5. 检查LLM服务是否可用

### 问题2：填写内容不准确

**症状：** 生成的内容与提供的数据不符

**解决方案：**
1. 检查fill_data.json中的数据是否正确
2. 优化提示词，明确数据映射关系
3. 增加数据验证步骤
4. 使用更高性能的LLM模型

### 问题3：格式损坏

**症状：** Word文档打不开或格式错乱

**解决方案：**
1. 检查原始template.docx是否完整
2. 检查XML处理过程是否有错误
3. 查看process_with_llm.py中的日志
4. 尝试用 `xml_validation` 模板修复

### 问题4：页面合并失败

**症状：** `合并失败` 或 `merged_document.xml缺失`

**解决方案：**
1. 检查split_pages/目录中是否有所有页面
2. 确保每个页面XML格式正确
3. 检查内存是否充足（大文件可能需要更多内存）

---

## 📈 性能优化

### 1. 批量处理优化

```python
# 分批处理大文档
page_files = get_all_pages()
batch_size = 10

for i in range(0, len(page_files), batch_size):
    batch = page_files[i:i+batch_size]
    process_batch(batch)  # 并行处理
```

### 2. LLM调用优化

**使用缓存减少API调用：**
```python
from functools import lru_cache

@lru_cache(maxsize=128)
def get_llm_response(prompt):
    return llm.call(prompt)
```

**调整参数以加快响应：**
```python
config.temperature = 0.1  # 降低温度以加快收敛
config.max_tokens = 1000  # 减少令牌数
```

### 3. 并行处理

```python
from concurrent.futures import ThreadPoolExecutor

with ThreadPoolExecutor(max_workers=4) as executor:
    futures = [executor.submit(process_page, page) for page in pages]
    results = [f.result() for f in futures]
```

---

## 📚 高级用法

### 1. 自定义数据验证

```python
def validate_data(field_name, value):
    if field_name == 'amount':
        # 验证金额格式
        if not value.endswith('元'):
            raise ValueError("金额必须以'元'结尾")
    elif field_name == 'date':
        # 验证日期格式
        from datetime import datetime
        datetime.strptime(value, '%Y-%m-%d')
    return value
```

### 2. 条件化处理

```python
# 根据页面类型使用不同的模板
page_type = detect_page_type(page_info)

if page_type == 'form':
    template = PromptLibrary.get_template('tender_form')
elif page_type == 'table':
    template = PromptLibrary.get_template('table_data')
else:
    template = PromptLibrary.get_template('free_text')
```

### 3. 错误恢复

```python
# 如果LLM处理失败，回退到基础替换
try:
    llm_result = process_with_llm(page)
except Exception as e:
    print(f"LLM处理失败，使用基础替换: {e}")
    llm_result = basic_replace(page, fill_data)
```

---

## 🎓 最佳实践

1. **总是验证数据** - 在应用更新前验证数据
2. **保留备份** - 保留原始template.docx
3. **逐步测试** - 先用小文件测试
4. **监控成本** - 注意LLM API调用的成本
5. **记录日志** - 保存处理日志便于调试
6. **优化提示词** - 持续改进提示词质量

---

## 📞 支持和贡献

如有问题：
1. 查看对应脚本中的日志
2. 检查提示词是否清晰
3. 测试LLM连接
4. 验证填充数据格式

---

## 📋 文件清单

```
项目文件:
├── llm_connector.py           # LLM连接模块
├── prompt_library.py          # 提示词模板库
├── setup_llm_config.py        # LLM配置向导
├── process_with_llm.py        # 大模型处理脚本
├── smart_workflow.py          # 完整工作流
├── split_pages.py             # 页面分割脚本
├── merge_pages.py             # 页面合并脚本
├── xml_to_docx.py             # XML转Word脚本
└── 使用指南.md                 # 这个文件

数据文件:
├── template.docx              # 原始Word文档
├── llm_config.json            # LLM配置
├── fill_data.json             # 填充数据
└── split_pages/               # 分割的页面

输出文件:
├── merged_document.xml        # 合并后的XML
└── output_document.docx       # 最终Word文档
```

---

*更新时间：2026年1月13日*  
*版本：2.0 - 智能LLM集成版*
